name: Rust CI/CD Ultra Fast

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 1

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: nightly
        targets: aarch64-linux-android
        components: rust-src
    
    - name: Cache optimization
      uses: actions/cache@v4
      id: cargo-cache
      with:
        path: |
          ~/.cargo/registry/
          ~/.cargo/git/
          target/  # é¡¹ç›®æ ¹ç›®å½•çš„ target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Setup Android target
      run: rustup target add aarch64-linux-android
    
    - name: Prefetch dependencies
      working-directory: ./imagequant-sys
      run: |
        cargo fetch --target aarch64-linux-android
    
    - name: Build for Android
      working-directory: ./imagequant-sys
      env:
        RUSTFLAGS: "-C target-feature=+crt-static"
        # ä½¿ç”¨ç»å¯¹è·¯å¾„æŒ‡å‘é¡¹ç›®æ ¹ç›®å½•çš„ target
        CARGO_TARGET_DIR: "${{ github.workspace }}/target"
      run: |
        rustup component list --installed | grep rust-src || rustup component add rust-src
        
        echo "ğŸš€ åœ¨ imagequant-sys ç›®å½•å†…å¼€å§‹æ„å»º..."
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "CARGO_TARGET_DIR: $CARGO_TARGET_DIR"
        
        # åœ¨ imagequant-sys ç›®å½•å†…æ„å»º
        time cargo build \
          -Z build-std=std,panic_abort \
          --target aarch64-linux-android \
          --release \
          --verbose \
          -j $(nproc)
        
        echo "âœ… æ„å»ºå®Œæˆï¼Œæ£€æŸ¥äº§ç‰©..."
        # äº§ç‰©åº”è¯¥åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ target ä¸­
        if [ -f "${{ github.workspace }}/target/aarch64-linux-android/release/libimagequant_sys.a" ]; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸï¼äº§ç‰©åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ target ä¸­"
          ls -lh "${{ github.workspace }}/target/aarch64-linux-android/release/libimagequant_sys.a"
          file "${{ github.workspace }}/target/aarch64-linux-android/release/libimagequant_sys.a"
        else
          echo "âŒ æ„å»ºäº§ç‰©æœªæ‰¾åˆ°ï¼"
          echo "æœç´¢æ•´ä¸ªé¡¹ç›®ä¸­çš„ .a æ–‡ä»¶:"
          find "${{ github.workspace }}" -name "*.a" -type f 2>/dev/null | head -20
          echo "Target ç›®å½•å†…å®¹:"
          find "${{ github.workspace }}/target" -type f -name "*.a" 2>/dev/null | head -20 || echo "Target ç›®å½•æœªæ‰¾åˆ°æˆ–ä¸ºç©º"
          exit 1
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: imagequant-android-${{ github.sha }}
        # ä»é¡¹ç›®æ ¹ç›®å½•çš„ target ä¸Šä¼ 
        path: target/aarch64-linux-android/release/libimagequant_sys.a
        retention-days: 7
        compression-level: 6

    - name: Build metrics
      if: always()
      run: |
        echo "ğŸ“ˆ æ„å»ºç»Ÿè®¡:"
        echo "æ„å»ºçŠ¶æ€: ${{ job.status }}"
        echo "ç¼“å­˜å‘½ä¸­: ${{ steps.cargo-cache.outputs.cache-hit }}"
        echo "è¿è¡Œå™¨: ${{ runner.os }}-${{ runner.arch }}"
        echo "CPU: $(nproc) æ ¸å¿ƒ"
        
        # æ£€æŸ¥æ„å»ºäº§ç‰©
        echo "ğŸ” æ„å»ºäº§ç‰©æ£€æŸ¥:"
        if [ -f "target/aarch64-linux-android/release/libimagequant_sys.a" ]; then
          echo "âœ… äº§ç‰©ä½ç½®: target/aarch64-linux-android/release/libimagequant_sys.a"
          ls -lh "target/aarch64-linux-android/release/libimagequant_sys.a"
        elif [ -f "imagequant-sys/target/aarch64-linux-android/release/libimagequant_sys.a" ]; then
          echo "âœ… äº§ç‰©ä½ç½®: imagequant-sys/target/aarch64-linux-android/release/libimagequant_sys.a"
          ls -lh "imagequant-sys/target/aarch64-linux-android/release/libimagequant_sys.a"
        else
          echo "âŒ äº§ç‰©ä¸å­˜åœ¨äºé¢„æœŸä½ç½®"
        fi